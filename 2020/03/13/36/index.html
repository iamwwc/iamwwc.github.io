<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="广阔天地，大有可为"><title>Nginx如何处理请求？--翻译 | 胖成煤气罐</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><style type="text/css">.icon {
  vertical-align: -0.15em;
  fill: currentColor;
  overflow: hidden;
}</style><script src="//at.alicdn.com/t/font_1484091_u5pgqyl62w9.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-148409521-1','auto');ga('send','pageview');
</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx如何处理请求？--翻译</h1><a id="logo" href="/.">胖成煤气罐</a><p class="description">广阔天地，大有可为</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Nginx如何处理请求？--翻译</h1><div class="post-meta"><div class="post-date">2020-03-13</div><div class="post-tags"> | <a class="post-tag" href="/tags/翻译/">翻译</a></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.4k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 5</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><blockquote>
<p>本文翻译自：</p>
<p><a href="http://nginx.org/en/docs/http/request_processing.html#simple_php_site_configuratio" target="_blank" rel="noopener">http://nginx.org/en/docs/http/request_processing.html#simple_php_site_configuratio</a></p>
</blockquote>
<h3 id="基于域名的虚拟服务器"><a href="#基于域名的虚拟服务器" class="headerlink" title="基于域名的虚拟服务器"></a>基于域名的虚拟服务器</h3><p>nginx首先确定使用哪个server来处理请求。让我们看下面简单的配置，这三个server都监听80端口</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.org www.example.org;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.net www.example.net;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个配置文件中，nginx只通过检测请求header的Host字段来决定哪个server处理请求。如果Host的值没有匹配到任何一个server_name，或者请求根本不包含Host字段，那么nginx会将请求路由到这个端口的默认server。在上面的配置文件中，nginx的default server是第一个server块。当然，默认server也可以明确被确定，只需要在listen指令中添加default_server参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line">    server_name example.net www.example.net</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>default server参数从0.8.21版本开始提供。在早期的版本中，应该使用default参数</em></p>
<p>记住，default server是监听端口的，而不是server_name的属性。后面还会提到。</p>
<h3 id="如果丢弃掉没有Host字段的请求？"><a href="#如果丢弃掉没有Host字段的请求？" class="headerlink" title="如果丢弃掉没有Host字段的请求？"></a>如果丢弃掉没有Host字段的请求？</h3><p>没有Host字段的请求是非法请求，server可以通过定义如下server来拒绝。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name &quot;&quot;;</span><br><span class="line">    return 444;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>空server_name将会被用来匹配没有Host字段的请求，我们直接返回nginx的444代码。</p>
<p><em>从0.8.48版本开始，这已经是server name的默认设置的，所以 “” 可以省略不写。早期版本中默认server name将会使用操作系统的hostname</em></p>
<h3 id="混合使用基于域名和基于IP的虚拟主机"><a href="#混合使用基于域名和基于IP的虚拟主机" class="headerlink" title="混合使用基于域名和基于IP的虚拟主机"></a>混合使用基于域名和基于IP的虚拟主机</h3><p>让我们看一个更复杂的配置。下面的虚拟主机监听的不同的端口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 192.168.1.1:80;</span><br><span class="line">    server_name example.org www.example.org;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.1.1:80;</span><br><span class="line">    server_name example.net www.example.net;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.1.2:80;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个配置文件中，nginx首先检测请求的IP地址和端口并与server块中的listen指令对比。然后将请求的Host字段与server_name指令对照。如果找不到server_name，那么请求将会由默认server处理。比如，192.168.1.1:80端口收到的<a href="http://www.example.com的请求将会被192.168.1.1:80端口的默认server处理，这是因为www.example.com" target="_blank" rel="noopener">www.example.com的请求将会被192.168.1.1:80端口的默认server处理，这是因为www.example.com</a> server_name没有在这个端口定义。</p>
<p>正如早已指出的，default_server是listen port的属性，我们可以在不同的端口定义不同的default server。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 192.168.1.1:80;</span><br><span class="line">    server_name example.org www.example.org;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.1.1:80 default_server;</span><br><span class="line">    server_name example.net www.example.net;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.1.2:80 default_server;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一个简单的PHP网站配置"><a href="#一个简单的PHP网站配置" class="headerlink" title="一个简单的PHP网站配置"></a>一个简单的PHP网站配置</h3><p>现在让我们看下nginx如果选择location字段去处理一个典型的请求，如下是一个简易的PHP网站。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name example.org www.example.org;</span><br><span class="line">    root        /data/www;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index   index.html index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* \.(gif|jpg|png)$ &#123;</span><br><span class="line">        expires 30d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass  localhost:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME</span><br><span class="line">                      $document_root$fastcgi_script_name;</span><br><span class="line">        include       fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nginx首先搜索到最具体的location前缀而不会在意location出现的顺序。在上面的配置文件中，只有 <code>location /</code>被匹配，这是由于<code>/</code>可以匹配任何一个请求，但他会最后被使用。然后nginx按照个给出的顺序检测由正则表达式给出的<code>location</code>。第一个匹配的location会中断nginx的搜索，然后nginx会直接使用这个location，如果没有正则表达式匹配这个请求，那么nginx会使用最普适的location前缀，这里会使用刚才搜索到的<code>location /</code></p>
<p>记住location字段仅仅检测URI部分，忽略query arguments。这样是由于query string会以多种不同的方式呈现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/index.php?user=john&amp;page=1</span><br><span class="line">/index.php?page=1&amp;user=john</span><br></pre></td></tr></table></figure>

<p>除此之外，任何人都能够在query string里面添加任何信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?page=1&amp;something+else&amp;user=john</span><br></pre></td></tr></table></figure>

<p>现在让我们看下请求如何按照上面的配置文件处理</p>
<p>的</p>
<ul>
<li><p>请求 <code>/logo.git</code>被前缀 / 首先匹配，然后被正则表达式 <code>\. (git|jpg|png)$</code>匹配。指令 <code>root /data/www</code>将 对于 <code>/logo.gif</code>映射成 <code>/data/www/logo.git</code>，于是文件发给了客户端</p>
</li>
<li><p>请求 <code>/index.php</code>也首先被 / 匹配，然后被 <code>\. (php)$</code>匹配。因此请求被之后的location处理，请求会被传递给监听在 <code>localhost:9000</code>的Fast CGI<code>。 fastcgi_param</code>指令将<code>SCRIPT_FILENAME</code>设置为 <code>/data/www/index.php</code>，然后 <code>FastCGI</code>服务器执行 <code>/data/www/index.php</code>文件。 <code>$document_root</code>相当于 <code>root</code>指令，变量 <code>$fastcgi_script_name</code>相当于请求的URI（/index.php） 。</p>
</li>
<li><p>请求 <code>about.html</code>仅仅被 / 匹配，因此它会被这个location处理，指令 <code>root /data/www</code>映射成了 <code>/data/www/about.html</code>，最后文件被发送给了客户端。</p>
</li>
<li><p>对于 / 的请求却更加复杂。它仅被 <code>/ location</code>匹配，因此它被这个location匹配。然后 <code>index</code>指令根据它的参数测试 index 文件是否存在。如果 <code>/data/www/index.html</code>文件不存在，但 <code>/data/www/index.php</code>文件存在，那么指令将会进行一次内部重定向，将请求定向到了 <code>/index.php</code>，nginx搜索再次搜索location块，这个请求就好像是由客户端发起的一样。正如我们之前看到了，被内部重定向的请求将会最终别 FastCGI服务处理。</p>
</li>
</ul>
<p>译者注：</p>
<blockquote>
<p>其实最后一种情况就是我们所说的伪静态，将 php 文件伪装成了 html 文件，内部重定向客户端察觉不到，可使用 <code>rewrite</code>指令完成伪静态。</p>
</blockquote>
</div><div class="tags"><a href="/tags/翻译/">翻译</a></div><div class="post-nav"><a class="pre" href="/2020/04/05/38/">英语思维-不断更新</a><a class="next" href="/2020/03/12/35/">Nginx配置Oneindex</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '2e81634cb0a32c318015',
  clientSecret: '33f6723010778fe273d4cee4ebbeb931fc826d7a',
  repo: 'blogsuepost',
  owner: 'iamwwc',
  admin: [''],
  id: md5(location.pathname),
  number: +('36'),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/转载/" style="font-size: 15px;">转载</a> <a href="/tags/Leetcode/" style="font-size: 15px;">Leetcode</a> <a href="/tags/Go/" style="font-size: 15px;">Go</a> <a href="/tags/基础/" style="font-size: 15px;">基础</a> <a href="/tags/云计算/" style="font-size: 15px;">云计算</a> <a href="/tags/杂七杂八/" style="font-size: 15px;">杂七杂八</a> <a href="/tags/算法与数据结构/" style="font-size: 15px;">算法与数据结构</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/年终总结/" style="font-size: 15px;">年终总结</a> <a href="/tags/Rust/" style="font-size: 15px;">Rust</a> <a href="/tags/编程语言/" style="font-size: 15px;">编程语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/06/08/54/">Rust-Pin提出的必要性-以及我对Pin的认识</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/01/53/">Rust学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/21/52/">数据表的设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/12/51/">Typescript动态类型推断</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/11/49/">React Hook使用小记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/11/50/">Redux为什么需要中间件来处理异步数据流？</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/15/48/">Actor Model 编程模型浅谈</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/25/47/">Redux-thunk代码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/24/46/">我眼中的Redux</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/25/45/">读Go泛型提案有感</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 常年混迹于</i></div><div class="icon-container"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-GitHub"/></svg><a class="link" href="https://github.com/iamwwc" title="Github" target="_blank">Github</a></div><div class="icon-container"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu"/></svg><a class="link" href="https://www.zhihu.com/people/wu-wei-chao-97/activities" title="知乎" target="_blank">知乎</a></div><div class="icon-container"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo"/></svg><a class="link" href="https://weibo.com/6415416577/profile" title="微博" target="_blank">微博</a></div><div class="icon-container"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-CN_bilibiliB"/></svg><a class="link" href="https://space.bilibili.com/154206647" title="bilibili" target="_blank">bilibili</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><div id="cp">Copyright © 2021 <a href="/." rel="nofollow">胖成煤气罐.</a></div><div id="beian"><a href="http://beian.miit.gov.cn/">鲁ICP备18026609号</a></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/jquery.fancybox.min.js" defer></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" defer></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>